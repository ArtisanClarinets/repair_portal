# Repair Portal App Review Report

## Executive Summary
The repair_portal app delivers a broad clarinet-focused service stack across intake, inspection, repair execution, diagnostics, and customer tooling. The data model is extensive (91 DocTypes) with deep specialization for pad maps, diagnostics, and consent handling, and the backend includes robust utilities for mapping estimates to repair orders and pushing ERPNext documents downstream.【F:repair_portal/repair/doctype/repair_order/repair_order.py†L1-L350】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L126】 However, multiple blueprint-critical capabilities remain partial or missing: customer approvals are captured as free text instead of workflow actions, there is no automated intake→estimate→invoice orchestration, photo evidence and barcoded job tags are inconsistent, and the scheduler lacks background jobs for warranty or SLA monitoring. Security gaps in the customer portal (misaligned ownership checks, leaking QA checklists) and brittle integrations (pad map route pointing to a non-existent DocType) pose operational risk. Addressing these gaps, aligning workflows with the Clarinet Repair Software Feature Blueprint (2025), and hardening permissions should be top priorities.

## Repository Map
- **DocTypes (91 total)**: Intake (Clarinet Intake, Loaner Instrument), Service Planning (Repair Estimate, Service Plan), Repair (Repair Request, Repair Order, Repair Quotation + items/materials), Instrument Profile & diagnostics (Instrument Profile, Diagnostic Metrics, Measurement Session), QA (Final QA Checklist), Inventory (Pad Count Intake/Log), Repair Logging (Repair Task Log, Tone Hole Inspection Record), Consent suite, Tools calibration, Lab measurement artifacts.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L126】【F:repair_portal/service_planning/doctype/repair_estimate/repair_estimate.json†L1-L22】【F:repair_portal/repair/doctype/repair_order/repair_order.json†L1-L112】【F:repair_portal/lab/doctype/measurement_session/measurement_session.json†L1-L120】 
- **Server Logic**: Rich controllers in `repair/doctype/repair_order`, `repair/utils`, pad-count computer vision pipeline, lab API, consent workflows, portal APIs.【F:repair_portal/repair/doctype/repair_order/repair_order.py†L1-L350】【F:repair_portal/repair/utils.py†L1-L200】【F:repair_portal/inventory/doctype/pad_count_intake/pad_count_intake.py†L1-L200】【F:repair_portal/lab/api.py†L1-L200】 
- **Client Logic**: Form scripts for intake, repair orders, setup templates, consent forms, plus specialized pages (`lab_console`, `technician_dashboard`).【F:repair_portal/lab/page/lab_console/lab_console.js†L1-L160】【F:repair_portal/repair/doctype/repair_order/repair_order.js†L1-L160】 
- **Pages & Web**: Technician dashboard desk page, lab console page, `/repair_pulse` and `/pad_map` web routes, standalone frontend shell.【F:repair_portal/inspection/page/technician_dashboard/technician_dashboard.js†L1-L160】【F:repair_portal/www/repair_pulse.py†L1-L36】【F:repair_portal/www/pad_map.py†L1-L32】 
- **Hooks & Jobs**: Extensive `doc_events` wiring for Repair Order ecosystem but no scheduler events; install hooks seed consent artifacts.【F:repair_portal/hooks.py†L21-L121】 
- **Assets**: Bundled JS for technician dashboard, lab UI, public tone processors; assets under `public/js` and `/www/frontend.html` for SPA shell.【F:repair_portal/public/js/technician_dashboard/technician_dashboard.bundle.js†L1-L40】【F:repair_portal/www/frontend.html†L1-L20】 
- **Notifications & Workflows**: Instrument and consent notifications, workflows for intake, repair order, customer, tools, QA.【F:repair_portal/instrument_profile/notification/instrument_status_change/instrument_status_change.json†L1-L40】【F:repair_portal/repair/workflow/repair_order_workflow/repair_order_workflow.json†L1-L120】 

## Data Model Audit (Spotlight)
- **Clarinet Intake** captures identity, customer consent, condition scoring, accessories, and photo links, but customer approval is a free-text field without workflow integration or signature capture, weakening compliance with blueprint-grade approval audits.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L126】 
- **Repair Estimate & Service Plan** separate planning data but rely on loose Data fields (no Link to Instrument Profile, Customer, or Intake), preventing referential integrity and downstream automation.【F:repair_portal/service_planning/doctype/repair_estimate/repair_estimate.json†L1-L22】【F:repair_portal/service_planning/doctype/service_plan/service_plan.json†L1-L68】 
- **Repair Quotation → Repair Order** mapping is robust (idempotent generation, labor/parts separation, invoice creation), yet Repair Order child tables lack enforced unique keys for tasks/materials, and workflow relies on manual transitions without SLA timers.【F:repair_portal/repair/doctype/repair_order/repair_order.py†L77-L350】【F:repair_portal/repair/doctype/repair_order/repair_order.json†L1-L112】 
- **Instrument Profile** stores woodwind-specific metadata and links to diagnostics, but warranty fields are optional and there is no enforced asset ownership linking to player consent, causing gaps in the service history chain expected by the blueprint.【F:repair_portal/instrument_profile/doctype/instrument_profile/instrument_profile.json†L1-L200】 
- **Diagnostics & Logging**: Measurement Session, Diagnostic Metrics, Tone Hole Inspection Record, Repair Task Log provide granular data capture yet rely heavily on script-managed relationships; missing unique naming schemes or SLA timestamps risk duplication.【F:repair_portal/repair_logging/doctype/diagnostic_metrics/diagnostic_metrics.json†L1-L160】【F:repair_portal/repair_logging/doctype/repair_task_log/repair_task_log.json†L1-L160】 
- **Customer Consent Suite** is extensive (templates, linked sources, logs) aligning with blueprint compliance needs, but cross-linking to intake approvals is manual, not automated.【F:repair_portal/customer/doctype/consent_form/consent_form.json†L1-L160】 

Refer to `DATA_MODEL_AUDIT.csv` for full inventory (generated as part of this audit).【F:repair_portal/docs/DATA_MODEL_AUDIT.csv†L1-L5】 

## UX & Workflow Audit
- **Intake → Inspection**: Clarinet Intake workflow covers statuses from New to Complete, includes photo and accessory logging, and triggers timeline entries via hooks. Instrument Inspection DocType (with measurement and tone hole logs) feeds into Service Plan and Repair Estimate, but status transitions rely on manual updates and there is no automated creation of estimates or orders upon approval.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L126】【F:repair_portal/hooks.py†L49-L117】 
- **Estimate → Approval**: Repair Quotation supports acceptance metadata and direct Repair Order creation, yet there is no customer-facing approval route (portal/DocType workflow) and `customer_accepted` is only set on back-office actions.【F:repair_portal/repair/doctype/repair_quotation/repair_quotation.py†L49-L140】 
- **Work Execution**: Repair Order handles planned vs actual materials, technician assignment, QA requirements, and invoices. Repair Task Log, Diagnostic Metrics, and Measurement Session provide detailed capture, but linking is enforced via hooks rather than guided UI, and there is no consolidated technician mobile experience or barcode-driven job cards as mandated by the blueprint.【F:repair_portal/repair/utils.py†L1-L200】【F:repair_portal/repair_logging/doctype/repair_task_log/repair_task_log.json†L1-L160】 
- **QA → Delivery**: Final QA Checklist exists with workflow states, but Customers have read access to QA records by default, which is risky. Delivery handoff lacks print formats for job tags with barcodes and there is no automated notification on QA pass/fail.【F:repair_portal/qa/doctype/final_qa_checklist/final_qa_checklist.json†L1-L78】 
- **Customer Portal & Pulse**: `/repair_pulse` exposes timeline updates yet authorizes by comparing customer Link to user ID, enabling unauthorized access when Customer names differ from user IDs. Portal APIs for “my repairs” filter on a non-existent `instrument` field, so clients receive empty lists and cannot track progress, violating blueprint customer experience targets.【F:repair_portal/www/repair_pulse.py†L14-L36】【F:repair_portal/api/client_portal.py†L11-L43】 
- **Diagnostics UX**: Lab Console page offers advanced capture, referencing lab APIs for audio uploads and analysis, aligning with specialized blueprint features. However, results aren’t surfaced in customer-facing workflows or reports, limiting commercial value.【F:repair_portal/lab/page/lab_console/lab_console.js†L1-L160】【F:repair_portal/lab/api.py†L67-L200】 

## Security & Permissions Notes
- Customer role can create Repair Requests and read Final QA Checklist entries; combined with `/repair_pulse` authorization flaw, this exposes PII and internal QA to unverified users.【F:repair_portal/repair/doctype/repair_request/repair_request.json†L131-L158】【F:repair_portal/qa/doctype/final_qa_checklist/final_qa_checklist.json†L50-L78】【F:repair_portal/www/repair_pulse.py†L14-L36】 
- Portal API filter mismatch (`Repair Order.instrument` vs `instrument_profile`) prevents accurate tenant scoping, potentially returning all repair orders if schema is customized with `instrument` field. Needs explicit ownership enforcement via joins on Customer/Instrument Profile.【F:repair_portal/api/client_portal.py†L27-L40】【F:repair_portal/repair/doctype/repair_order/repair_order.json†L1-L112】 
- `/pad_map` route queries `Clarinet Repair Log`, which is absent in the repo, causing runtime errors and hinting at missing permission-scope definitions for pad data.【F:repair_portal/www/pad_map.py†L1-L32】 
- No `scheduler_events` defined, so long-running warranty expiry checks (cron file exists) never run, leaving SLA alerts dormant and violating blueprint uptime requirements.【F:repair_portal/hooks.py†L21-L121】【F:repair_portal/instrument_profile/cron/warranty_expiry_check.py†L1-L120】 

## Key Risks & Gaps vs Blueprint
1. **Customer Approval & Portal Transparency** – Intake, estimates, and QA lack formal approval workflows, portal APIs malfunction, and status visibility is limited, failing the blueprint’s customer-facing milestones (Scalable Specialist strategy emphasizes transparent approvals and payment-ready portals).【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L126】【F:repair_portal/api/client_portal.py†L27-L40】【F:repair_portal/www/repair_pulse.py†L14-L36】 
2. **Operational Orchestration** – No automated progression from intake to repair order, no scheduler-driven SLA or warranty jobs, and no barcode job tags, leaving technicians without the structured workflow mandated by the blueprint.【F:repair_portal/hooks.py†L49-L121】【F:repair_portal/instrument_profile/cron/warranty_expiry_check.py†L1-L120】【F:repair_portal/repair/workflow/repair_order_workflow/repair_order_workflow.json†L1-L120】 
3. **Data Integrity & Linking** – Planning DocTypes use Data fields instead of Links, portal filters reference missing schema, and web routes depend on non-existent DocTypes, risking data loss and runtime failures during critical workflows.【F:repair_portal/service_planning/doctype/repair_estimate/repair_estimate.json†L1-L22】【F:repair_portal/api/client_portal.py†L27-L40】【F:repair_portal/www/pad_map.py†L1-L32】 
4. **Security Exposure** – Customer read access to QA, flawed portal authorization, and numerous whitelisted endpoints without explicit permission checks increase breach risk for PII and operational metrics, contrary to enterprise expectations.【F:repair_portal/qa/doctype/final_qa_checklist/final_qa_checklist.json†L50-L78】【F:repair_portal/www/repair_pulse.py†L14-L36】【F:repair_portal/lab/api.py†L67-L200】 
5. **Reporting & Analytics** – Diagnostics capture exists, but there are limited aggregated reports for performance, SLA compliance, or revenue vs cost analytics (reports folder sparse), missing blueprint KPI coverage.

## Recommendations
1. **Implement Blueprint-grade Customer Workflow**: Add structured approval DocTypes (signature capture, status transitions) tied to portal actions, fix portal ownership queries, and expose real-time status + payments per the Clarinet Repair Software Feature Blueprint (2025).【F:repair_portal/api/client_portal.py†L27-L40】【F:repair_portal/www/repair_pulse.py†L14-L36】 
2. **Automate Intake→Order Orchestration**: Extend hooks or introduce background tasks to auto-generate estimates/orders upon approval, enforce SLA timers, and wire warranty cron via `scheduler_events` with monitoring alerts.【F:repair_portal/hooks.py†L49-L121】【F:repair_portal/instrument_profile/cron/warranty_expiry_check.py†L1-L120】 
3. **Harden Data Model**: Convert planning fields to Links, ensure unique indexes on serials/logs, add missing DocType exports (Pulse Update), and resolve `/pad_map` dependencies to prevent runtime failures.【F:repair_portal/service_planning/doctype/repair_estimate/repair_estimate.json†L1-L22】【F:repair_portal/www/pad_map.py†L1-L32】 
4. **Security Tightening**: Remove customer read permissions from QA internals, add explicit permission checks in portal APIs and lab endpoints, and enforce user/customer linkage before returning sensitive data.【F:repair_portal/qa/doctype/final_qa_checklist/final_qa_checklist.json†L50-L78】【F:repair_portal/api/client_portal.py†L27-L40】【F:repair_portal/lab/api.py†L67-L200】 
5. **Operational Assets**: Deliver barcode-enabled print formats, mobile-friendly technician views, and aggregated diagnostic dashboards to meet blueprint’s Scalable Specialist differentiators. 

## Blueprint Reference
All recommendations align with the “Clarinet Repair Software Feature Blueprint” (2025) – Scalable Specialist strategy emphasizing transparent customer approvals, instrument-specific diagnostics, automated SLA enforcement, and technician mobility.
