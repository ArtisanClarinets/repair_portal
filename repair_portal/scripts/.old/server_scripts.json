[
  {
    "doctype": "Server Script",
    "name": "Clarinet Template: populate child rows",
    "enabled": 1,
    "script_type": "DocType Event",
    "reference_doctype": "Project Template",
    "doctype_event": "After Save",
    "view": "Server",
    "module": "Projects",
    "script": "\n# Populate Project Template.tasks by resolving Task names from subjects (works with autoname)\nTEMPLATE_NAME = 'B♭ Clarinet Standard Setup (v1.0)'\nORDER = [\n  'Perform Environmental Logging & Acclimatization',\n  'Complete Visual and Tactile Inspection',\n  'Assess Initial Tenon Fit (No Grease)',\n  'Execute Standardized Break-In Schedule',\n  'Perform Bore Oiling',\n  'Verify Tone Hole Geometry',\n  'Perform Precision Tenon Cork Replacement',\n  'Select and Install All Pads',\n  'Optimize Key Heights (Venting)',\n  'Calibrate Spring Tensions',\n  'Perform Inter-Key Regulation',\n  'Validate System-Wide Airtightness',\n  'Generate Empirical Pitch Curve',\n  'Perform Voicing & Micro-Adjustments',\n  'Complete Final Performance Validation',\n  'Generate Certificate of Acoustic Performance'\n]\n\nif doc.name == TEMPLATE_NAME:\n  # subject -> Task.name (only template tasks)\n  rows = frappe.get_all('Task', filters={'is_template': 1, 'subject': ['in', ORDER]}, fields=['name','subject'])\n  by_subject = {r['subject']: r['name'] for r in rows}\n\n  # existing links\n  existing = set([r.task for r in (doc.tasks or []) if r.task])\n\n  changed = False\n  for subj in ORDER:\n    taskname = by_subject.get(subj)\n    if taskname and taskname not in existing:\n      doc.append('tasks', {'doctype': 'Project Template Task', 'task': taskname})\n      changed = True\n\n  if changed:\n    doc.save(ignore_permissions=True)\n"
  },
  {
    "doctype": "Server Script",
    "name": "Clarinet Template: wire dependencies",
    "enabled": 1,
    "script_type": "DocType Event",
    "reference_doctype": "Project",
    "doctype_event": "After Insert",
    "view": "Server",
    "module": "Projects",
    "condition": "doc.project_template == 'B♭ Clarinet Standard Setup (v1.0)'",
    "script": "\n# Add Task Depends On rows inside the created Project by matching subjects\n# --- Bolt Optimization: Replaced N+1 `get_doc` with a single `get_all` to pre-fetch tasks ---\nCHAIN = [\n    ('Complete Visual and Tactile Inspection','Perform Environmental Logging & Acclimatization'),\n    ('Assess Initial Tenon Fit (No Grease)','Complete Visual and Tactile Inspection'),\n    ('Execute Standardized Break-In Schedule','Assess Initial Tenon Fit (No Grease)'),\n    ('Perform Bore Oiling','Execute Standardized Break-In Schedule'),\n    ('Verify Tone Hole Geometry','Perform Bore Oiling'),\n    ('Perform Precision Tenon Cork Replacement','Verify Tone Hole Geometry'),\n    ('Select and Install All Pads','Perform Precision Tenon Cork Replacement'),\n    ('Optimize Key Heights (Venting)','Select and Install All Pads'),\n    ('Calibrate Spring Tensions','Optimize Key Heights (Venting)'),\n    ('Perform Inter-Key Regulation','Calibrate Spring Tensions'),\n    ('Validate System-Wide Airtightness','Perform Inter-Key Regulation'),\n    ('Generate Empirical Pitch Curve','Validate System-Wide Airtightness'),\n    ('Perform Voicing & Micro-Adjustments','Generate Empirical Pitch Curve'),\n    ('Complete Final Performance Validation','Perform Voicing & Micro-Adjustments'),\n    ('Generate Certificate of Acoustic Performance','Complete Final Performance Validation')\n]\n\nproj = doc.name\n\n# Pre-fetch all project tasks and their existing dependencies in one query to avoid N+1 reads.\n# This is a significant performance improvement over fetching each task one by one.\ntasks_with_deps = frappe.get_all(\n    'Task',\n    filters={'project': proj},\n    fields=['name', 'subject', '`tabTask Depends On`.task as dependent_task']\n)\n\n# Create a map of subject -> name for quick lookups.\nby_subject = {t.subject: t.name for t in tasks_with_deps}\n\n# Create a map of task_name -> set_of_dependencies for efficient checking.\nexisting_deps = {}\nfor t in tasks_with_deps:\n    if t.name not in existing_deps:\n        existing_deps[t.name] = set()\n    if t.dependent_task:\n        existing_deps[t.name].add(t.dependent_task)\n\n# Iterate through the dependency chain and add any missing `depends_on` rows.\n# This uses the ORM's `get_doc` and `save` methods to ensure all business logic\n# (validation, hooks, etc.) is correctly triggered. While still a loop, it's now\n# operating on pre-fetched data, and its correctness is prioritized over raw SQL speed.\nfor child_subj, parent_subj in CHAIN:\n    child_name = by_subject.get(child_subj)\n    parent_name = by_subject.get(parent_subj)\n\n    if not child_name or not parent_name:\n        continue\n\n    # Check if the dependency already exists using our pre-fetched map.\n    if parent_name not in existing_deps.get(child_name, set()):\n        # Load the document, append the new dependency, and save.\n        # This is the correct, safe way to modify documents in Frappe.\n        task_doc = frappe.get_doc('Task', child_name)\n        task_doc.append('depends_on', {'task': parent_name})\n        task_doc.save(ignore_permissions=True)\n"
  }
]
