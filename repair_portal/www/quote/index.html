{% extends "templates/web.html" %}
{% block page_content %}
<section class="quote-approval">
  <h1>Repair Estimate</h1>
  <article class="estimate-card">
    <p><strong>Customer:</strong> {{ estimate.customer }}</p>
    <p><strong>Instrument:</strong> {{ estimate.instrument }}</p>
    <p><strong>Repair Order:</strong> {{ estimate.repair_order }}</p>
    <p><strong>Base Deposit:</strong> ${{ "%.2f"|format(estimate.deposit_amount or 0) }}</p>
  </article>
  {% if upsell_options %}
  <div class="upsells">
    <h3>Optional Enhancements</h3>
    <form id="quote-form">
      <input type="hidden" name="estimate" value="{{ estimate.name }}">
      <input type="hidden" name="token" value="{{ token }}">
      <ul class="upsell-list">
        {% for option in upsell_options %}
        <li>
          <label>
            <input type="checkbox" name="upsell" value="{{ option.item }}" {% if option.item in [u.item for u in estimate.upsell_selected if u.accepted] %}checked{% endif %}>
            <span class="upsell-title">{{ option.item }}</span>
            <span class="upsell-price">${{ "%.2f"|format(option.price or 0) }}</span>
            {% if option.description %}<span class="upsell-desc">{{ option.description }}</span>{% endif %}
          </label>
        </li>
        {% endfor %}
      </ul>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Approve &amp; Pay Deposit</button>
      </div>
    </form>
  </div>
  {% else %}
  <p>No additional options are available for this estimate.</p>
  <form id="quote-form">
    <input type="hidden" name="estimate" value="{{ estimate.name }}">
    <input type="hidden" name="token" value="{{ token }}">
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Approve &amp; Pay Deposit</button>
    </div>
  </form>
  {% endif %}
  <div id="quote-success" class="alert alert-success" style="display:none;"></div>
  <div id="quote-error" class="alert alert-danger" style="display:none;"></div>
</section>
<script>
(function() {
  const form = document.getElementById('quote-form');
  const successEl = document.getElementById('quote-success');
  const errorEl = document.getElementById('quote-error');
  if (!form) return;
  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    const formData = new FormData(form);
    const estimate = formData.get('estimate');
    const token = formData.get('token');
    const upsells = [];
    form.querySelectorAll('input[name="upsell"]:checked').forEach((checkbox) => {
      upsells.push(checkbox.value);
    });
    try {
      const response = await frappe.call({
        method: 'repair_portal.www.quote.index.submit_quote_decision',
        type: 'POST',
        args: {
          estimate,
          token,
          upsells: JSON.stringify(upsells)
        }
      });
      if (response.message && response.message.payment_url) {
        successEl.innerHTML = `<p>Deposit total: $${response.message.deposit_amount.toFixed(2)}</p><p>Redirecting to Stripe Checkout&hellip;</p>`;
        successEl.style.display = 'block';
        window.location.href = response.message.payment_url;
      }
    } catch (error) {
      const message = (error && error.message) ? error.message : 'Unable to prepare deposit. Please contact the shop.';
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
  });
})();
</script>
{% endblock %}
