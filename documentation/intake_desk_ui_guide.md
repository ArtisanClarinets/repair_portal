# Clarinet Intake Desk UX Hardening Guide

## 1. Scope & Source Artifacts
This guide covers every file under `repair_portal/intake`, including DocTypes, controllers, list views, dashboards, print formats, web forms, hooks, services, and utilities that shape the desk experience for clarinet intake operations. Representative assets include the Clarinet Intake DocType metadata, client script, and controller automation【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L1-L495】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L1-L211】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.py†L1-L552】, the loaner workflows and accessory child table【F:repair_portal/intake/doctype/loaner_instrument/loaner_instrument.json†L1-L141】【F:repair_portal/intake/doctype/intake_accessory_item/intake_accessory_item.json†L1-L64】, and supporting APIs, dashboards, analytics, and notifications【F:repair_portal/intake/api.py†L1-L175】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_dashboard.py†L1-L69】【F:repair_portal/intake/utils/emailer.py†L1-L92】【F:repair_portal/intake/report/intake_sla_pulse/intake_sla_pulse.py†L1-L97】.

## 2. Current Desk Strengths
- **Workflow-driven visual telemetry.** The DocType exposes workflow-state HTML widgets (`workflow_stage_badge`, `sla_commitment_panel`) that present clarinet-specific SLAs, overdue badges, and escalation banners, keeping coordinators ahead of timeline risks.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L26-L123】 Client scripts hydrate these widgets with branded markup, technician cues, and workflow actions tied to the consolidated API surface.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L29-L211】
- **Automation that keeps downstream teams synchronized.** The controller automatically creates Items, Instrument Serial Numbers, Instruments, Inspections, Initial Setups, and consent forms, logging each action to the timeline for auditability.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.py†L134-L348】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_timeline.py†L21-L135】 This reduces data entry friction and ensures technicians receive ready-to-work records.
- **List view accelerators for operations leaders.** The custom ListView script adds color-coded indicators, SLA-aware quick filters, actions for bulk workflow nudges, and shortcuts to related doctypes, aligning with fast triage needs in a busy repair shop.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_list.js†L1-L189】
- **Loaner instrument governance.** Loaner Instrument maintains status-driven lifecycle fields, signature capture, and links back to intakes; the Return Check child DocType captures condition evidence with photo support to protect against disputes and is now restricted to staff roles.【F:repair_portal/intake/doctype/loaner_instrument/loaner_instrument.json†L19-L134】【F:repair_portal/intake/doctype/loaner_return_check/loaner_return_check.json†L44-L70】
- **Notifications & contact hygiene.** The shared emailer composes branded intake updates, while `intake_sync.py` provides idempotent customer/contact upserts so desk staff can trust CRM records when escalating cases.【F:repair_portal/intake/utils/emailer.py†L13-L91】【F:repair_portal/intake/services/intake_sync.py†L12-L92】

## 3. Gap Remediation Highlights
- **Unified state model & SLA surfacing.** The read-only `intake_status` Select has been retired in favor of workflow-driven UI sourced from `workflow_state`, ensuring every transition (including cancellation paths) is enforced consistently across the DocType, workflow JSON, and client script badges.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L24-L160】【F:repair_portal/intake/workflow/intake_workflow/intake_workflow.json†L1-L276】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L13-L207】
- **Heatmap analytics restored.** `clarinet_intake_timeline.get_timeline_data` now powers the dashboard heatmap with aggregated comment, version, inspection, and repair-order counts so executives can spot bottlenecks directly from the desk form.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_timeline.py†L80-L135】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_dashboard.py†L21-L69】
- **API consolidation & ownership guards.** Duplicate helpers were removed from the controller; `repair_portal.intake.api` now enforces contact→customer→intake ownership chains for serial lookups and inspection access, with structured error logging for audit trails.【F:repair_portal/intake/api.py†L1-L175】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.py†L476-L552】
- **Modern print surfaces.** Intake Receipt renders QR-coded job tags, clarinet condition grids, and technician sign-offs using only live fields, relying on the shared Jinja helper for barcode generation so front-of-house paperwork matches enterprise expectations.【F:repair_portal/intake/print_format/intake_receipt.json†L1-L82】【F:repair_portal/utils/jinja.py†L1-L116】
- **Intake intake pipeline refinements.** Loaner QA DocTypes now restrict customer permissions, the public web form captures clarinet transport, risk, and photo evidence, and the workspace surfaces the Intake SLA Pulse report for executive oversight.【F:repair_portal/intake/doctype/loaner_return_check/loaner_return_check.json†L44-L70】【F:repair_portal/intake/web_form/clarinet_intake_request/clarinet_intake_request.json†L1-L161】【F:repair_portal/repair_portal/workspace/repair_portal/repair_portal.json†L72-L140】
- **Template loader & fixtures corrected.** Intake setup templates now load from dedicated JSON fixtures to seed consent, inspection, and SLA defaults without touching unrelated Item Groups.【F:repair_portal/intake/hooks/load_templates.py†L1-L50】【F:repair_portal/intake/hooks/templates/clarinet_intake_defaults.json†L1-L13】

## 4. Sustaining the Fortune-500 UX Playbook
1. **Keep workflow visuals authoritative.** Future workflow updates must adjust `workflow_state` options first, then refresh badge rendering in the client script so the HTML widgets remain a single source of truth.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L29-L211】
2. **Monitor analytics integrity.** Schedule nightly smoke tests (or run `verify_intake_module.py`) to confirm heatmap data and SLA counters populate successfully, guarding against schema drift in dependent doctypes.【F:repair_portal/intake/scripts/verify_intake_module.py†L173-L289】
3. **Protect external access.** Any new portal endpoint should extend the hardened ownership checks in `repair_portal.intake.api` to prevent regressions in customer visibility.【F:repair_portal/intake/api.py†L46-L175】
4. **Re-export fixtures after UI/permission changes.** Keep workspace cards, notifications, and templates synchronized by re-running the template loader and exporting fixtures whenever defaults evolve.【F:repair_portal/intake/hooks/load_templates.py†L1-L50】

## 5. Implementation Checklist
- Map every workflow state to desk indicators and timeline badges; verify approvals drive notifications via `utils.emailer` and the consolidated API routes.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_list.js†L20-L189】【F:repair_portal/intake/utils/emailer.py†L13-L91】
- Deliver a consolidated Intake Overview dashboard with heatmap data, SLA counters, and loaner status chips to surface aging work at login.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_dashboard.py†L21-L69】
- Tighten portal/customer permissions before exposing new UI; rely on `intake_sync.py` for clean CRM data so desk automations can trust lookup results.【F:repair_portal/intake/services/intake_sync.py†L12-L92】
- Archive redundant code paths (duplicated API helpers, stale template loader) and backfill regression tests to ensure future Fortune-500 hardening stays green.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.py†L476-L552】【F:repair_portal/intake/scripts/verify_intake_module.py†L34-L289】

Following this playbook keeps the Clarinet Intake desk experience aligned with enterprise expectations—clear states, reliable analytics, security-first APIs, polished documents, and proactive communications that keep technicians, managers, and customers in lockstep.

## 6. Implementation Status (2025-10-05)
- ✅ Workflow badges, SLA panels, and cancellation paths are now driven directly from `workflow_state`, with the DocType exposing contextual HTML, the form/dashboard rendering live indicators, and the workflow JSON adding Repair Manager cancel actions for every stage.【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.json†L24-L160】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L13-L207】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_list.js†L13-L189】【F:repair_portal/intake/workflow/intake_workflow/intake_workflow.json†L1-L276】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake_timeline.py†L1-L135】
- ✅ Intake APIs are consolidated behind `repair_portal.intake.api` with ownership-aware guards and customer-facing error logging, and the client script now exclusively calls these hardened endpoints.【F:repair_portal/intake/api.py†L1-L175】【F:repair_portal/intake/doctype/clarinet_intake/clarinet_intake.js†L13-L207】
- ✅ The Intake Receipt print format delivers QR-coded job tags, clarinet condition grids, and commercial summaries that only reference live fields, eliminating the previous blank placeholders.【F:repair_portal/intake/print_format/intake_receipt.json†L1-L82】
- ✅ Loaner QA records are internal-only; customer permissions were removed from Loaner Return Check to enforce staff-driven sign-off.【F:repair_portal/intake/doctype/loaner_return_check/loaner_return_check.json†L44-L70】
- ✅ The public Clarinet Intake web form captures clarinet type, logistics, risk disclosures, humidity history, and photo evidence so desk staff receive complete dossiers on submission.【F:repair_portal/intake/web_form/clarinet_intake_request/clarinet_intake_request.json†L1-L161】
- ✅ Operations leaders have direct access to the Intake SLA Pulse analytics from the workspace, aligning the launchpad with SLA monitoring expectations.【F:repair_portal/repair_portal/workspace/repair_portal/repair_portal.json†L72-L140】
- ✅ Intake template loading targets Clarinet Intake defaults via fixtures that can be safely re-run without touching unrelated Item Groups.【F:repair_portal/intake/hooks/load_templates.py†L1-L50】【F:repair_portal/intake/hooks/templates/clarinet_intake_defaults.json†L1-L13】
- ✅ The Intake SLA Pulse script report surfaces backlog counts, overdue promises, and loaner risk in one view to support Fortune-500 governance reviews.【F:repair_portal/intake/report/intake_sla_pulse/intake_sla_pulse.json†L1-L28】【F:repair_portal/intake/report/intake_sla_pulse/intake_sla_pulse.py†L1-L97】
